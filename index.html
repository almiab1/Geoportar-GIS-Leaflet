<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Projecto Leaflet - GIS 19/20 - GTI</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

	<!-- Boostrap -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
		integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous">
	</script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
		integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
	</script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
		integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
	</script>

	<!-- Load Leaflet from CDN -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
		integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
		crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
		integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
		crossorigin=""></script>

	<!-- Load Esri Leaflet from CDN -->
	<script src="https://unpkg.com/esri-leaflet@2.3.2/dist/esri-leaflet.js"
		integrity="sha512-6LVib9wGnqVKIClCduEwsCub7iauLXpwrd5njR2J507m3A2a4HXJDLMiSZzjcksag3UluIfuW1KzuWVI5n/cuQ=="
		crossorigin=""></script>

	<!-- Load Esri Leaflet Geocoder from CDN -->
	<link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.3.2/dist/esri-leaflet-geocoder.css"
		integrity="sha512-IM3Hs+feyi40yZhDH6kV8vQMg4Fh20s9OzInIIAc4nx7aMYMfo+IenRUekoYsHZqGkREUgx0VvlEsgm7nCDW9g=="
		crossorigin="">
	<script src="https://unpkg.com/esri-leaflet-geocoder@2.3.2/dist/esri-leaflet-geocoder.js"
		integrity="sha512-8twnXcrOGP3WfMvjB0jS5pNigFuIWj4ALwWEgxhZ+mxvjF5/FBPVd5uAxqT8dd2kUmTVK9+yQJ4CmTmSg/sXAQ=="
		crossorigin=""></script>

	<!-- Plugin para Medición areas y distancias-->
	<link rel="stylesheet" href="https://ljagis.github.io/leaflet-measure/leaflet-measure.css">
	<!-- Plugin para el minimapa -->
	<link rel="stylesheet" href="./plugins/control.MiniMap.css" />
	<link rel="stylesheet" href="./plugins/control.MousePosition.css" />
	<!-- GeoTIFF -->
	<script src="https://ihcantabria.github.io/Leaflet.CanvasLayer.Field/dist/leaflet.canvaslayer.field.js"></script>
	<!-- Plugin custom layers -->
	<link rel="stylesheet" href="./plugins/styledLayerControl.css" />
	<script src="./plugins/styledLayerControl.js"></script>
	<!-- Plugin para la Impresión -->
	<link href='http://fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

	<style>
		html,
		body {
			width: 100%;
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			background: #262626;
		}

		#map {
			position: relative;
			margin: 0;
			padding: 0;
			right: 0;
			left: 0;
			height: 100vh;
			width: 100%;
		}
	</style>
</head>

<body>
	<!-- Plugins y librerias leaflet ---------------------------------------------------------------------------------------------------------------------- -->
	<!-- Chroma -->
	<script src="./plugins/chroma.min.js" type="text/javascript"></script>
	<!-- d3 -->
	<script src="./plugins/d3.v4.min.js" type="text/javascript"></script>
	<!-- GeoTIFF -->
	<script src="./plugins/geotiff.js" type="text/javascript"></script>
	<!-- Plugin para el GEOTIF-->
	<script src="./plugins/leaflet.canvaslayer.field.js" type="text/javascript"></script>
	<!-- Plugin para el minimapa -->
	<script src="./plugins/control.MiniMap.js" type="text/javascript"></script>
	<script src="./plugins/control.MousePosition.js" type="text/javascript"></script>
	<!-- Plugin para medición -->
	<script src="plugins/leaflet-measure.js" type="text/javascript"></script>
	<!-- Plugin Shp -->
	<script src="./plugins/leaflet.shpfile.js" type="text/javascript"></script>
	<script src="./plugins/shp.js" type="text/javascript"></script>
	<script src="./plugins/leaflet-providers.js" type="text/javascript"></script>
	<!-- Plugin impresion -->
	<script src="./plugins/bundle.js" type="text/javascript"></script>
	<!-- -------------------------------------------------------------------------------------------------------------------------------------------------- -->


	<div class="container-fluid">

		<div class="row">
			<!-- <nav class="col-12 navbar navbar-expand-lg navbar-dark bg-dark h-10">
				<div class="col-lg-5">
					<img src="./data/img/UPV-gandia-blanco.png" width="150" height="85" class="" alt="Responsive image">
				</div>
				<div class="col-lg-6 d-flex align-items-center">
					<h1 class="text-white">Proyecto TIG 19/20 - GTI</h1>
				</div>
				<div class="col-lg-1 d-flex justify-content-end">
					Button trigger modal
					<button type="button" class="btn btn-info text-white" data-toggle="modal"
						data-target="#infoModal">
						+Info
					</button>
				</div>
			</nav> -->
			<div class="col-lg-9 col-md-12">
				<div id="map"> </div>
			</div>

			<div class="col-lg-3 col-md-12 card-black">
				<img class="card-img-top" src="./data/img/UPV-gandia-blanco.png" alt="Card image cap">
				<div class="card-body text-white">
					<h2 class="card-title"><strong><u>Proyecto TIG 19/20 - GTI</u></strong></h2>
					<p class="card-text">
						Proyecto paraa la asignatura Tecnologías de la información geográfica, reaización de un
						geoportal con distintos tipos de capas ( raster , vectoriales).<br>
					</p>
					<table class="table table-borderless text-white">
						<thead>
							<tr>
								<th></th>
								<th>Capas raster</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<th scope="row">1</th>
								<td>Temperatura Media Anual 2007</td>
							</tr>
							<tr>
								<th scope="row">2</th>
								<td>Precipitaciones Media en España 2007</td>
							</tr>
						</tbody>
						
						<thead>
							<tr>
								<th></th>
								<th>Capas vectoriales</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<th scope="row">1</th>
								<td>Contorno de temperatura media</td>
							</tr>
							<tr>
								<th scope="row">2</th>
								<td>Contorno de precipitaciones medias</td>
							</tr>
							<tr>
								<th scope="row">3</th>
								<td>Corine incendio</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="card-footer">
					<button type="button" class="btn btn-info text-white w-100" data-toggle="modal"
						data-target="#infoModal">
						+Info
					</button>
					<h6 class="text-white p-3"><strong>Autor: Alejandro Mira Abad</strong></h6>
				</div>
			</div>
		</div>


		<!-- Modal -->
		<div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModallLabel"
			aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered" role="document">
				<div class="modal-content">
					<div class="modal-header bg-info text-white">
						<h5 class="modal-title" id="infoModallLabel">Acerca de...</h5>
						<button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<label>Proyecto TIG 19/20 - GTI</label> <br>
						<label>
							Proyecto de geoportal en Leaflet para la asignatura
							<a href="https://www.upv.es/titulaciones/GTI/menu_1015445c.html" target="_blank">Tecnologías
								de la
								información
								geográfica</a>
							del
							<a href="https://www.upv.es/titulaciones/GTI/indexc.html" target="_blank">Grado en
								Tecnologías
								Interactivas
							</a>
						</label> <br>
						<label>Autor: <b>Alejandro Mira Abad</b></label><br>
						<label>Contacto: <a href="mailito:almiab1@epsg.upv.es">almiab1@epsg.upv.es</a></label>
					</div>
				</div>
			</div>
		</div>

	</div>

	<script>
		//----------------------------------------------------------------------------------------------------------------------
		// Creacion del mapa y añadido de layers
		//----------------------------------------------------------------------------------------------------------------------
		// Añadir las papas GEOTIF a los layers
		//----------------------------------------------------------------------------------------------------------------------
		var capasTemperaturaMedia = new L.layerGroup();
		anyadirGeotif("./data/temperaturaMediaTIFF.tif", capasTemperaturaMedia, 'Spectral', 'Temperatura: ', ' ºC');
		var capaPrecipiMediaAnual2007 = new L.layerGroup()
		anyadirGeotif("./data/precipiMediaAnual2007.tif", capaPrecipiMediaAnual2007, ['blue', '#63FFD9'], 'Precipitación: ',
			' l/m2');
		//----------------------------------------------------------------------------------------------------------------------
		//----------------------------------------------------------------------------------------------------------------------
		// Cargar los shp
		//----------------------------------------------------------------------------------------------------------------------
		// Cargo shp contorno temperaturas
		var contornoTemp_layerGroup = new L.layerGroup(); // Creo el layer group
		// Leo el shp y lo añado a un layer
		var contornoTemp = new L.Shapefile("./data/contornoTemp.zip", {
			onEachFeature: (feature, marker) => {}
		});
		contornoTemp.addTo(contornoTemp_layerGroup); // añado el layer al layerGroup

		// Cargo shp contorno precipit
		var contornoLluvia_layerGroup = new L.layerGroup(); // Creo el layer group
		// Leo el shp y lo añado a un layer
		var contornoLluvia = new L.Shapefile("./data/contornosPrecip.zip", {
			onEachFeature: (feature, marker) => {}
		});
		contornoLluvia.addTo(contornoLluvia_layerGroup); // añado el layer al layerGroup

		// Cargo shp contorno precipit
		var puntosTemp_layerGroup = new L.layerGroup(); // Creo el layer group
		// Leo el shp y lo añado a un layer
		var puntosTemp = new L.Shapefile("./data/puntosTem.zip", {
			onEachFeature: (feature, marker) => {
				marker.bindPopup(`
                    <h5>Nombre:</h5> ${feature.properties.NOMBRE}
                    <h5>Temperatura:</h5> ${feature.properties.JUN} ºC
                    <h5>ID de la estación:</h5> ${feature.properties.ID_EST}
                    <h5>Coordenadas:</h5> ${feature.properties.LAT},${feature.properties.LONG}
                    `);
			}
		});
		puntosTemp.addTo(puntosTemp_layerGroup); // añado el layer al layerGroup

		//----------------------------------------------------------------------------------------------------------------------
		var gray = new L.layerGroup();
		var baseMapInicial = L.esri.basemapLayer('DarkGray').addTo(gray);
		L.esri.basemapLayer('GrayLabels').addTo(
			gray);

		var map = L.map('map', {
			center: [38.996426, -0.165339],
			zoom: 4,
			layers: [gray],
		});

		var baseLayers = [{
			groupName: "Base maps",
			layers: {
				"Grayscale": gray,
				"Streetmap": L.esri.basemapLayer('Streets')
			}
		}];

		var layers = [{
				groupName: "Temperaturas",
				layers: {
					"Temperatura Media Anual 2007": capasTemperaturaMedia,
					"Contorno de temperatura media": contornoTemp_layerGroup,
					"Puntos": puntosTemp_layerGroup,
				}
			},
			{
				groupName: "Precipitaciones",
				layers: {
					"Precipitaciones Media en España 2007": capaPrecipiMediaAnual2007,
					"Contorno de precipitaciones medias": contornoLluvia_layerGroup,
				}
			}
		];

		var options = {
			container_width: "300px",
			group_maxHeight: "400px",
			exclusive: false,
			position: 'topright'
		};

		var control = L.Control.styledLayerControl(baseLayers, layers, options);
		map.addControl(control);
		//----------------------------------------------------------------------------------------------------------------------
		//Añadir shp combinacion incendio corine
		fetch('./data/corine.zip')
			.then(async function (response, error) {

				var corine = L.shapefile(response.url, {
					style: (feature) => {
						return {
							fillColor: getColorVegetacion(feature.properties.AREA_HA),
							weight: 1, // Grosor del borde
							opacity: 1,
							color: 'white',
							dashArray: '3',
							fillOpacity: 0.8
						};

					}
				});

				control.addOverlay(corine, "Corine incendio", {
					groupName: "Incendio"
				});

				//Popup
				corine.on('click', function (e) {
					// Cogemos el valor
					let tipo = e.layer.feature.properties.DESC_;
					let area = e.layer.feature.properties.AREA_HA;
					// Creamos el html
					let html = ('<h6>Tipo de vegetación:</h6>' + tipo + '<br> <h6>Área:</h6> ' + area.toFixed(
						2) + 'ha');

					let popup = L.popup()
						.setLatLng(e.latlng)
						.setContent(html)
						.openOn(map);
				});

			}); // fetch

		function getColorVegetacion(area) {
			return area > 400 ? '#253494' :
				area > 300 ? '#2c7fb8' :
				area > 200 ? '#41b6c4' :
				area > 100 ? '#a1dab4' :
				'#ffffcc';
		}
		//----------------------------------------------------------------------------------------------------------------------
		// Mini mapa
		//----------------------------------------------------------------------------------------------------------------------
		var osm2 = new L.TileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png');
		var miniMap = new L.Control.MiniMap(osm2, {
			toggleDisplay: true,
			zoomLevelOffset: -6
		}).addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Barra de medida
		//----------------------------------------------------------------------------------------------------------------------
		let measureControl = new L.Control.Measure({
			position: 'topleft',
			primaryLengthUnit: 'meters',
			secondaryLengthUnit: 'kilometers',
			primaryAreaUnit: 'hectares',
			activeColor: 'green',
			completedColor: 'blue'
		});
		measureControl.addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Impresion mapa
		//----------------------------------------------------------------------------------------------------------------------
		var printer = L.easyPrint({
			tileLayer: baseMapInicial,
			sizeModes: ['Current', 'A4Landscape', 'A4Portrait'],
			filename: 'map',
			exportOnly: true,
			hideControlContainer: true
		}).addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Barra de busqueda
		//----------------------------------------------------------------------------------------------------------------------
		var arcgisOnline = L.esri.Geocoding.arcgisOnlineProvider();

		L.esri.Geocoding.geosearch({
			providers: [
				arcgisOnline,
				L.esri.Geocoding.mapServiceProvider({
					label: 'States and Counties',
					url: 'https://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer',
					layers: [2, 3],
					searchFields: ['NAME', 'STATE_NAME']
				})
			]
		}).addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Barra escalado
		//----------------------------------------------------------------------------------------------------------------------
		var escaleBar = L.control.scale({
			position: 'bottomleft',
			metric: true,
			maxWidth: 300
		}).addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Funcion para añadir TIFF al mapa
		//----------------------------------------------------------------------------------------------------------------------
		function anyadirGeotif(url, layerGroup, color, tituloHtml, unidades) {
			var tiff = url;
			fetch(tiff).then(r => r.arrayBuffer()).then(function (buffer) {
				var s = L.ScalarField.fromGeoTIFF(buffer);
				let layer = L.canvasLayer.scalarField(s, {
					color: chroma.scale(color).mode('lab').domain(s.range.reverse()),
					opacity: 0.65
				}).addTo(layerGroup);
				layer.on("click", function (e) {
					if (e.value !== null) {
						let popup = L.popup()
							.setLatLng(e.latlng)
							.setContent(tituloHtml + `${Math.floor(e.value, -1)}` + unidades +
								`<br> Posicion: ${e.latlng.lat} ${e.latlng.lng} `)
							.openOn(map);
					}
				});
				map.fitBounds(layer.getBounds());
			});
		}
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Cuando seleccionamos una capa, hazer zoom a ella
		//----------------------------------------------------------------------------------------------------------------------
		map.on('overlayadd', (e) => {
			map.fitBounds(e.layer.getBounds());
			map.closePopup();
		});
		//----------------------------------------------------------------------------------------------------------------------
	</script>

</body>

</html>