<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Projecto Leaflet - GIS 19/20 - GTI</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

	<!-- Boostrap -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
		integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous">
	</script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
		integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
	</script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
		integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
	</script>

	<!-- Modo carga -->
	<link rel="stylesheet" href="./plugins/estilosCargando.css">

	<!-- Load Leaflet from CDN -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
		integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
		crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
		integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
		crossorigin=""></script>


	<!-- Load Esri Leaflet from CDN -->
	<script src="https://unpkg.com/esri-leaflet@2.3.2/dist/esri-leaflet.js"
		integrity="sha512-6LVib9wGnqVKIClCduEwsCub7iauLXpwrd5njR2J507m3A2a4HXJDLMiSZzjcksag3UluIfuW1KzuWVI5n/cuQ=="
		crossorigin=""></script>

	<!-- Load Esri Leaflet Geocoder from CDN -->
	<link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.3.2/dist/esri-leaflet-geocoder.css"
		integrity="sha512-IM3Hs+feyi40yZhDH6kV8vQMg4Fh20s9OzInIIAc4nx7aMYMfo+IenRUekoYsHZqGkREUgx0VvlEsgm7nCDW9g=="
		crossorigin="">
	<script src="https://unpkg.com/esri-leaflet-geocoder@2.3.2/dist/esri-leaflet-geocoder.js"
		integrity="sha512-8twnXcrOGP3WfMvjB0jS5pNigFuIWj4ALwWEgxhZ+mxvjF5/FBPVd5uAxqT8dd2kUmTVK9+yQJ4CmTmSg/sXAQ=="
		crossorigin=""></script>

	<!-- Plugin para Medición areas y distancias-->
	<link rel="stylesheet" href="./plugins/leaflet-measure.css">
	<!-- Plugin para el minimapa -->
	<link rel="stylesheet" href="./plugins/control.MiniMap.css" />
	<!-- GeoTIFF -->
	<script src="https://ihcantabria.github.io/Leaflet.CanvasLayer.Field/dist/leaflet.canvaslayer.field.js"></script>
	<!-- Plugin custom layers -->
	<link rel="stylesheet" href="./plugins/styledLayerControl.css" />
	<script src="./plugins/styledLayerControl.js"></script>

	<script src="https://cdn.rawgit.com/calvinmetcalf/shapefile-js/gh-pages/dist/shp.js"></script>
    <script src="https://cdn.rawgit.com/calvinmetcalf/leaflet.shapefile/gh-pages/leaflet.shpfile.js"></script>

	<style>
		body {
			margin: 0;
			padding: 0;
		}

		#map {
			position: fixed;
			right: 0;
			left: 0;
			height: 100%;
		}
	</style>
</head>

<body>

	<div class="d-flex flex-column">
		<nav class="p-12 navbar navbar-expand-lg navbar-dark bg-dark">
			<a class="navbar-brand" href="#">Projecto GIS 19/20 - GTI</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
				aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="d-flex justify-content-end navbar-nav mr-auto">
					<li class="p-2 nav-item active">
						<a class="nav-link" href="#">Home<span class="sr-only">(current)</span></a>
					</li>
					<li class="p-2 nav-item dropdown">
						<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
							data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							Acerca de
						</a>
						<div class="dropdown-menu" aria-labelledby="navbarDropdown">
							<a class="dropdown-item">Esta pagina está hecha por Alejandro Mira Abad</a>
						</div>
					</li>
				</ul>
			</div>
		</nav>
	</div>

	<!-- <div class="ring">
		<labl>LOADING</labl>
		<span class="spanRing"></span>
	</div> -->
	<main role="main" class="d-flex flex-column">
		<div class="p-12" id="map"></div>
	</main>

	<!-- Plugins y librerias leaflet ---------------------------------------------------------------------------------------------------------------------- -->
	<!-- Chroma -->
	<script src="./plugins/chroma.min.js" type="text/javascript"></script>
	<!-- d3 -->
	<script src="./plugins/d3.v4.min.js" type="text/javascript"></script>
	<!-- GeoTIFF -->
	<script src="./plugins/geotiff.js" type="text/javascript"></script>
	<!-- Plugin para el GEOTIF-->
	<script src="./plugins/leaflet.canvaslayer.field.js" type="text/javascript"></script>
	<!-- Plugin para el minimapa -->
	<script src="./plugins/control.MiniMap.js" type="text/javascript"></script>
	<!-- Plugin para medición -->
	<script src="plugins/leaflet-measure.js" type="text/javascript"></script>
	<!-- Plugin Shp -->
	<!-- <script src="./plugins/leaflet.shpfile.js" type="text/javascript"></script>
	<script src="./plugins/shp.js" type="text/javascript"></script> -->
	<script src="./plugins/leaflet-providers.js" type="text/javascript"></script>

	<!-- -------------------------------------------------------------------------------------------------------------------------------------------------- -->

	<script>
		//----------------------------------------------------------------------------------------------------------------------
		// Creacion del mapa y añadido de layers
		//----------------------------------------------------------------------------------------------------------------------
		// Añadir las papas GEOTIF a los layers
		//----------------------------------------------------------------------------------------------------------------------
		var capasTemperaturaMedia = new L.layerGroup();
		anyadirGeotif("./data/temperaturaMediaTIFF.tif", capasTemperaturaMedia, 'Spectral', 'Temperatura: ', ' ºC');
		var capaPrecipiMediaAnual2007 = new L.layerGroup()
		anyadirGeotif("./data/precipiMediaAnual2007.tif", capaPrecipiMediaAnual2007, ['blue', '#63FFD9'], 'Precipitación: ',
			' l/m2');
		//----------------------------------------------------------------------------------------------------------------------
		//----------------------------------------------------------------------------------------------------------------------
		// Cargar los shp
		//----------------------------------------------------------------------------------------------------------------------
		// Cargo shp corine_incendios
		var corine_incendios_layerGroup = new L.layerGroup(); // Creo el layer group
		// Leo el shp y lo añado a un layer
		var corine_incendios = new L.Shapefile('./data/cuadriculas.zip', {
			onEachFeature: function (feature, marker) {
				if (feature.properties) {
					layer.bindPopup(Object.keys(feature.properties).map(function(k) {
						return k + ": " + feature.properties[k];
					}).join("<br />"), {
						maxHeight: 200
					});
				}
			}
		}); 
		corine_incendios.addTo(corine_incendios_layerGroup); // añado el layer al layerGroup
		// Funcion que comprueba si se carga los datos
		corine_incendios.once("data:loaded", function() {
			console.log("finished loaded shapefile");
		});
		//----------------------------------------------------------------------------------------------------------------------
		var gray = new L.layerGroup();
		var baseMapInicial = L.esri.basemapLayer('DarkGray').addTo(gray);
		L.esri.basemapLayer('GrayLabels').addTo(gray);

		var map = L.map('map', {
			center: [38.996426, -0.165339],
			zoom: 4,
			layers: [gray],
		});

		var baseLayers = [{
			groupName: "Base maps",
			layers: {
				"Grayscale": gray,
				"Streetmap": L.esri.basemapLayer('Streets')
			}
		}];

		var layers = [{
				groupName: "Capas TIFF",
				layers: {
					"Temperatura Media Anual 2007": capasTemperaturaMedia,
					"Precipitaciones Media Anual 2007": capaPrecipiMediaAnual2007,
				}
			},
			{
				groupName: "Capas .shp",
				layers: {
					"Incendios": corine_incendios_layerGroup,
				}
			}
		];

		var options = {
			container_width: "300px",
			group_maxHeight: "400px",
			exclusive: false,
			position: 'topright'
		};

		var control = L.Control.styledLayerControl(baseLayers, layers, options);
		map.addControl(control);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Barra de busqueda
		//----------------------------------------------------------------------------------------------------------------------
		var arcgisOnline = L.esri.Geocoding.arcgisOnlineProvider();

		L.esri.Geocoding.geosearch({
			providers: [
				arcgisOnline,
				L.esri.Geocoding.mapServiceProvider({
					label: 'States and Counties',
					url: 'https://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer',
					layers: [2, 3],
					searchFields: ['NAME', 'STATE_NAME']
				})
			]
		}).addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Barra de medida
		//----------------------------------------------------------------------------------------------------------------------
		// var measureControl = new L.Control.Measure({
		// 	position: 'topleft',
		// 	primaryLengthUnit: 'meters',
		// 	secondaryLengthUnit: 'kilometers',
		// 	primaryAreaUnit: 'hectares',
		// 	activeColor: 'green',
		// 	completedColor: 'blue'
		// });
		// measureControl.addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Mini mapa
		//----------------------------------------------------------------------------------------------------------------------
		// var osm2 = new L.TileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png');
		// var miniMap = new L.Control.MiniMap(osm2, {
		// 	toggleDisplay: true,
		// 	zoomLevelOffset: -6
		// }).addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Funcion para añadir TIFF al mapa
		//----------------------------------------------------------------------------------------------------------------------
		function anyadirGeotif(url, layerGroup, color, tituloHtml, unidades) {
			var tiff = url;
			fetch(tiff).then(r => r.arrayBuffer()).then(function (buffer) {
				var s = L.ScalarField.fromGeoTIFF(buffer);
				let layer = L.canvasLayer.scalarField(s, {
					color: chroma.scale(color).mode('lab').domain(s.range.reverse()),
					opacity: 0.65
				}).addTo(layerGroup);
				layer.on("click", function (e) {
					if (e.value !== null) {
						let popup = L.popup()
							.setLatLng(e.latlng)
							.setContent(tituloHtml + `${Math.floor(e.value, -1)}` + unidades +
								`<br> Posicion: ${e.latlng}`)
							.openOn(map);
					}
				});
				map.fitBounds(layer.getBounds());
			});
		}
	</script>

</body>

</html>