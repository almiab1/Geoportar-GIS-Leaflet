<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Projecto Leaflet - GIS 19/20 - GTI</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

	<!-- Boostrap -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
		integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous">
	</script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
		integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
	</script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
		integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
	</script>

	<!-- Modo carga -->
	<link rel="stylesheet" href="./plugins/estilosCargando.css">

	<!-- Load Leaflet from CDN -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
		integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
		crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
		integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
		crossorigin=""></script>


	<!-- Load Esri Leaflet from CDN -->
	<script src="https://unpkg.com/esri-leaflet@2.3.2/dist/esri-leaflet.js"
		integrity="sha512-6LVib9wGnqVKIClCduEwsCub7iauLXpwrd5njR2J507m3A2a4HXJDLMiSZzjcksag3UluIfuW1KzuWVI5n/cuQ=="
		crossorigin=""></script>

	<!-- Load Esri Leaflet Geocoder from CDN -->
	<link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.3.2/dist/esri-leaflet-geocoder.css"
		integrity="sha512-IM3Hs+feyi40yZhDH6kV8vQMg4Fh20s9OzInIIAc4nx7aMYMfo+IenRUekoYsHZqGkREUgx0VvlEsgm7nCDW9g=="
		crossorigin="">
	<script src="https://unpkg.com/esri-leaflet-geocoder@2.3.2/dist/esri-leaflet-geocoder.js"
		integrity="sha512-8twnXcrOGP3WfMvjB0jS5pNigFuIWj4ALwWEgxhZ+mxvjF5/FBPVd5uAxqT8dd2kUmTVK9+yQJ4CmTmSg/sXAQ=="
		crossorigin=""></script>

	<!-- Plugin para Medición areas y distancias-->
	<link rel="stylesheet" href="https://ljagis.github.io/leaflet-measure/leaflet-measure.css">
	<!-- Plugin para el minimapa -->
	<link rel="stylesheet" href="./plugins/control.MiniMap.css" />
	<!-- GeoTIFF -->
	<script src="https://ihcantabria.github.io/Leaflet.CanvasLayer.Field/dist/leaflet.canvaslayer.field.js"></script>
	<!-- Plugin custom layers -->
	<link rel="stylesheet" href="./plugins/styledLayerControl.css" />
	<script src="./plugins/styledLayerControl.js"></script>

	<!-- <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script> -->

	<style>
		body {
			margin: 0;
			padding: 0;
		}

		#map {
			position: fixed;
			right: 0;
			left: 0;
			height: 92%;
		}

		#logoCampusGandia {
			margin-left: 1rem;
		}
	</style>
</head>

<body>

	<nav class="row navbar navbar-expand-lg navbar-dark bg-dark">
		<div class="col-4">
			<img class="logoCampusGandia" src="./data/img/UPV-gandia-blanco.png" width="150" height="85" class=""
				alt="Responsive image">
		</div>
		<div class="col-6">
			<h1 class="text-white">Projecto GIS 19/20 - GTI</h1>
		</div>
		<div class="col-2 d-flex justify-content-end">
			<!-- Button trigger modal -->
			<button type="button" class="btn btn-info text-white" data-toggle="modal" data-target="#exampleModal">
				+Info
			</button>
		</div>
	</nav>

	<!-- Modal -->
	<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header bg-info text-white">
					<h5 class="modal-title" id="exampleModalLabel">Acerca de...</h5>
					<button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<label>Projecto GIS 19/20 - GTI</label> <br>
					<label>
						Projecto de geoportal en Leaflet para la asignatura 
						<a href="https://www.upv.es/titulaciones/GTI/menu_1015445c.html">Tecnologías de la información geográfica</a>
						del
						<a href="https://www.upv.es/titulaciones/GTI/indexc.html">Grado en Tecnologías Interactivas
						</a>
					</label> <br>
					<label>Autor: Alejandro Mira Abad</label>
				</div>
			</div>
		</div>
	</div>

	<!-- <div class="ring">
		<labl>LOADING</labl>
		<span class="spanRing"></span>
	</div> -->
	<main role="main" class="d-flex flex-column">
		<div class="p-12" id="map"></div>
	</main>

	<!-- Plugins y librerias leaflet ---------------------------------------------------------------------------------------------------------------------- -->
	<!-- Chroma -->
	<script src="./plugins/chroma.min.js" type="text/javascript"></script>
	<!-- d3 -->
	<script src="./plugins/d3.v4.min.js" type="text/javascript"></script>
	<!-- GeoTIFF -->
	<script src="./plugins/geotiff.js" type="text/javascript"></script>
	<!-- Plugin para el GEOTIF-->
	<script src="./plugins/leaflet.canvaslayer.field.js" type="text/javascript"></script>
	<!-- Plugin para el minimapa -->
	<script src="./plugins/control.MiniMap.js" type="text/javascript"></script>
	<!-- Plugin para medición -->
	<script src="plugins/leaflet-measure.js" type="text/javascript"></script>
	<!-- Plugin Shp -->
	<script src="./plugins/leaflet.shpfile.js" type="text/javascript"></script>
	<script src="./plugins/shp.js" type="text/javascript"></script>
	<script src="./plugins/leaflet-providers.js" type="text/javascript"></script>

	<!-- -------------------------------------------------------------------------------------------------------------------------------------------------- -->

	<script>
		//----------------------------------------------------------------------------------------------------------------------
		// Creacion del mapa y añadido de layers
		//----------------------------------------------------------------------------------------------------------------------
		// Añadir las papas GEOTIF a los layers
		//----------------------------------------------------------------------------------------------------------------------
		var capasTemperaturaMedia = new L.layerGroup();
		anyadirGeotif("./data/temperaturaMediaTIFF.tif", capasTemperaturaMedia, 'Spectral', 'Temperatura: ', ' ºC');
		var capaPrecipiMediaAnual2007 = new L.layerGroup()
		anyadirGeotif("./data/precipiMediaAnual2007.tif", capaPrecipiMediaAnual2007, ['blue', '#63FFD9'], 'Precipitación: ',
			' l/m2');
		//----------------------------------------------------------------------------------------------------------------------
		//----------------------------------------------------------------------------------------------------------------------
		// Cargar los shp
		//----------------------------------------------------------------------------------------------------------------------
		// Cargo shp contorno temperaturas
		var contornoTemp_layerGroup = new L.layerGroup(); // Creo el layer group
		// Leo el shp y lo añado a un layer
		var contornoTemp = new L.Shapefile("./data/contornoTemp.zip", {
			onEachFeature: (feature, marker) => {}
		});
		contornoTemp.addTo(contornoTemp_layerGroup); // añado el layer al layerGroup
		// Cargo shp contorno precipit
		var contornoLluvia_layerGroup = new L.layerGroup(); // Creo el layer group
		// Leo el shp y lo añado a un layer
		var contornoLluvia = new L.Shapefile("./data/contornosPrecip.zip", {
			onEachFeature: (feature, marker) => {}
		});
		contornoLluvia.addTo(contornoLluvia_layerGroup); // añado el layer al layerGroup
		// Cargo shp contorno precipit
		var puntosTemp_layerGroup = new L.layerGroup(); // Creo el layer group
		// Leo el shp y lo añado a un layer
		var puntosTemp = new L.Shapefile("./data/puntosTem.zip", {
			onEachFeature: (feature, marker) => {
				marker.bindPopup(`
                    <h5>Nombre:</h5> ${feature.properties.NOMBRE}
                    <h5>Temperatura:</h5> ${feature.properties.JUN} ºC
                    <h5>ID de la estación:</h5> ${feature.properties.ID_EST}
                    <h5>Coordenadas:</h5> ${feature.properties.LAT},${feature.properties.LONG}
                    `);
			}
		});
		puntosTemp.addTo(puntosTemp_layerGroup); // añado el layer al layerGroup
		//----------------------------------------------------------------------------------------------------------------------
		var gray = new L.layerGroup();
		var baseMapInicial = L.esri.basemapLayer('DarkGray').addTo(gray);
		L.esri.basemapLayer('GrayLabels').addTo(gray);

		var map = L.map('map', {
			center: [38.996426, -0.165339],
			zoom: 4,
			layers: [gray],
		});

		var baseLayers = [{
			groupName: "Base maps",
			layers: {
				"Grayscale": gray,
				"Streetmap": L.esri.basemapLayer('Streets')
			}
		}];

		var layers = [{
				groupName: "Temperarutas",
				layers: {
					"Temperatura Media Anual 2007": capasTemperaturaMedia,
					"Contorno": contornoTemp_layerGroup,
					"Puntos": puntosTemp_layerGroup,
				}
			},
			{
				groupName: "Precipitaciones",
				layers: {
					"Precipitaciones Media en España 2007": capaPrecipiMediaAnual2007,
					"Contorno": contornoLluvia_layerGroup,
				}
			}
		];

		var options = {
			container_width: "300px",
			group_maxHeight: "400px",
			exclusive: false,
			position: 'topright'
		};

		var control = L.Control.styledLayerControl(baseLayers, layers, options);
		map.addControl(control);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Mini mapa
		//----------------------------------------------------------------------------------------------------------------------
		var osm2 = new L.TileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png');
		var miniMap = new L.Control.MiniMap(osm2, {
			toggleDisplay: true,
			zoomLevelOffset: -6
		}).addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Barra de medida
		//----------------------------------------------------------------------------------------------------------------------
		let measureControl = new L.Control.Measure({
			position: 'topleft',
			primaryLengthUnit: 'meters',
			secondaryLengthUnit: 'kilometers',
			primaryAreaUnit: 'hectares',
			activeColor: 'green',
			completedColor: 'blue'
		});
		measureControl.addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Barra de busqueda
		//----------------------------------------------------------------------------------------------------------------------
		var arcgisOnline = L.esri.Geocoding.arcgisOnlineProvider();

		L.esri.Geocoding.geosearch({
			providers: [
				arcgisOnline,
				L.esri.Geocoding.mapServiceProvider({
					label: 'States and Counties',
					url: 'https://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer',
					layers: [2, 3],
					searchFields: ['NAME', 'STATE_NAME']
				})
			]
		}).addTo(map);
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Funcion para añadir TIFF al mapa
		//----------------------------------------------------------------------------------------------------------------------
		function anyadirGeotif(url, layerGroup, color, tituloHtml, unidades) {
			var tiff = url;
			fetch(tiff).then(r => r.arrayBuffer()).then(function (buffer) {
				var s = L.ScalarField.fromGeoTIFF(buffer);
				let layer = L.canvasLayer.scalarField(s, {
					color: chroma.scale(color).mode('lab').domain(s.range.reverse()),
					opacity: 0.65
				}).addTo(layerGroup);
				layer.on("click", function (e) {
					if (e.value !== null) {
						let popup = L.popup()
							.setLatLng(e.latlng)
							.setContent(tituloHtml + `${Math.floor(e.value, -1)}` + unidades +
								`<br> Posicion: ${e.latlng}`)
							.openOn(map);
					}
				});
				map.fitBounds(layer.getBounds());
			});
		}
		//----------------------------------------------------------------------------------------------------------------------

		//----------------------------------------------------------------------------------------------------------------------
		// Cuando seleccionamos una capa, hazer zoom a ella
		//----------------------------------------------------------------------------------------------------------------------
		map.on('overlayadd', (e) => {
			map.fitBounds(e.layer.getBounds());
			map.closePopup();
		});
		//----------------------------------------------------------------------------------------------------------------------
	</script>

</body>

</html>